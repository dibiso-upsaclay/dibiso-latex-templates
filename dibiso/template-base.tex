% Language options
\newif\if@french
\newif\if@english

% Default to French
\@frenchtrue
\@englishfalse

\DeclareOption{french}{%
  \@frenchtrue
  \@englishfalse
  \PassOptionsToPackage{french}{babel}
}

\DeclareOption{english}{%
  \@englishfalse
  \@englishtrue
  \PassOptionsToPackage{english}{babel}
}

\DeclareOption*{\PassOptionsToClass{\CurrentOption}{\templatetype}}
\ProcessOptions\relax
\LoadClass[]{\templatetype}

% Load babel (it will use the options passed above)
\RequirePackage{babel}

% Language-specific customizations
\if@french
  \addto\captionsfrench{%
    \renewcommand{\contentsname}{Sommaire}%
  }
\fi
\if@english
  \addto\captionsenglish{%
    \renewcommand{\contentsname}{Table of contents}%
  }
\fi


% add command to define subtitle
\DeclareRobustCommand\subtitle[1]{\gdef\@subtitle{#1}}
\subtitle{}

% define the reporter and reporter email commands
\newcommand{\reporter}[1]{\gdef\@reporter{#1}}
\newcommand{\@reporter}{}
\newcommand{\thereporter}{\@reporter}
\newcommand{\reporteremail}[1]{\gdef\@reporteremail{#1}}
\newcommand{\@reporteremail}{}
\newcommand{\thereporteremail}{\@reporteremail}

%% Define commands to only cite labels defined in the document and ignore undefined labels

% Global variables to store results
\newcommand{\@figresult}{}
\newcommand{\@tabresult}{}

% Command to build a list of existing references
\newcommand{\buildreflist}[2]{%
  \begingroup
  \def\@reflist{}%
  \def\@refcount{0}%
  \@for\@temp:=#2\do{%
    \@ifundefined{r@\@temp}{}{%
      \ifx\@reflist\@empty
        \edef\@reflist{\ref{\@temp}}%
        \def\@refcount{1}%
      \else
        \edef\@reflist{\@reflist, \ref{\@temp}}%
        \edef\@refcount{\the\numexpr\@refcount+1\relax}%
      \fi
    }%
  }%
  \ifx\@reflist\@empty
    \xdef\@tempresult{}%
  \else
    \ifnum\@refcount>1
      \xdef\@tempresult{#1s \@reflist}%
    \else
      \xdef\@tempresult{#1 \@reflist}%
    \fi
  \fi
  \endgroup
}

% Check if any references exist
\newif\if@hasrefs
\newcommand{\checkrefsexist}[2]{%
  \buildreflist{figure}{#1}%
  \global\let\@figresult\@tempresult
  \buildreflist{table}{#2}%
  \global\let\@tabresult\@tempresult
  %
  \ifx\@figresult\@empty
    \ifx\@tabresult\@empty
      \@hasrefsfalse
    \else
      \@hasrefstrue
    \fi
  \else
    \@hasrefstrue
  \fi
}

% Combined command for figures and tables
\newcommand{\figtabrefs}[2]{%
  \buildreflist{figure}{#1}%
  \global\let\@figresult\@tempresult
  \buildreflist{table}{#2}%
  \global\let\@tabresult\@tempresult
  %
  \ifx\@figresult\@empty
    \ifx\@tabresult\@empty
      \notusedinthisreport
    \else
      \@tabresult
    \fi
  \else
    \ifx\@tabresult\@empty
      \@figresult
    \else
      \@figresult~; \@tabresult
    \fi
  \fi
}

% Counter to track if any items were added
\newcounter{descriptionitems}

% Conditional item that only shows if references exist
\newcommand{\conditionalitem}[3]{%
  % #1 = item label
  % #2 = figure references
  % #3 = table references
  \checkrefsexist{#2}{#3}%
  \if@hasrefs
    \stepcounter{descriptionitems}%
    \item[#1] \figtabrefs{#2}{#3}%
  \fi
}


% font
\RequirePackage{fontspec}
\RequirePackage[default,oldstyle,scale=0.95]{opensans} %% Alternatively
%% use the option 'defaultsans' instead of 'default' to replace the
%% sans serif font only.

% set title font
\newcommand{\titlefont}{\fontseries{l}}

\RequirePackage{parskip}

\RequirePackage{titlesec}
\RequirePackage{geometry}
\RequirePackage{setspace}
\RequirePackage{tikz}
\usetikzlibrary{colorbrewer}

\DeclareRobustCommand\subtitle[1]{\gdef\@subtitle{#1}}
\subtitle{}
\DeclareRobustCommand\titlerightlogo[1]{\gdef\@titlerightlogo{#1}}
\titlerightlogo{assets/logo.eps}
\DeclareRobustCommand\titleleftlogo[1]{\gdef\@titleleftlogo{#1}}
\titleleftlogo{assets/logo.eps}


%%Margins
\geometry{
  a4paper,
  left=30mm,
  right=30mm,
  top=30mm,
  bottom=30mm,
}


% bullet points color
\renewcommand{\labelitemi}{$\bulletpointcolor{\bullet}$}
\renewcommand{\labelitemii}{$\bulletpointcolor{\cdot}$}
\renewcommand{\labelitemiii}{$\bulletpointcolor{\diamond}$}
\renewcommand{\labelitemiv}{$\bulletpointcolor{\ast}$}




\RequirePackage{eso-pic}  % run stuff before anything (used to place the background before everything else)
\RequirePackage{graphicx}
\RequirePackage{ifthen}
\RequirePackage{lastpage}

% define command to set the background of the last page
\newcommand{\makelastpage}{
  \begin{tikzpicture}[remember picture, overlay, every node/.style={inner sep=0,outer sep=0}]
    % left laser:
    % left part of the shading
    \shade[left color=titlepagegradientcolora, right color=titlepagegradientcolorb, shading angle=0](current page.north east) rectangle ([xshift=-0.5\titlepagelaserwidth]current page.south east);
    % The yshift=0.2cm and yshift=-0.2cm are here to fix an alignement bug
    % right part of the shading with the fading on the right
    \shade[left color=titlepagegradientcolora, right color=titlepagegradientcolorb, shading angle=0, path fading=west]([xshift=-0.49\titlepagelaserwidth, yshift=0.2cm]current page.north east) rectangle ([xshift=-\titlepagelaserwidth, yshift=-0.2cm]current page.south east);
    % left part of the white shade
    \fill[color=white, path fading=east]([xshift=-0.22\titlepagelaserwidth, yshift=0.2cm]current page.north east) rectangle ([xshift=-0.301\titlepagelaserwidth, yshift=-0.2cm]current page.south east);
    % right part of the white shade
    \fill[color=white, path fading=west]([xshift=-0.299\titlepagelaserwidth, yshift=0.2cm]current page.north east) rectangle ([xshift=-0.38\titlepagelaserwidth, yshift=-0.2cm]current page.south east);
  \end{tikzpicture}
  \thispagestyle{empty}
}


% Add the background to every page until running out of pages in the background page
% reset titlepage environment to start page numbering on title page
\renewenvironment{titlepage}
  {\newpage\thispagestyle{empty}}
  {\newpage}
  % lualatex version
  \AddToShipoutPictureBG{
    \AtPageLowerLeft{
      \saveimageresource{\classdir /background.pdf}
      % if this is the last page of the document
      \ifthenelse{\thepage = \pageref{LastPage}}
        {
          % no background but add the laser to the page
          \makelastpage
        }
        {
          % if the background file not has enough pages
          \ifthenelse{\numexpr\thepage+1 > \the\lastsavedimageresourcepages}
          {
            % not background
          }
          {
            % add background
            \begin{tikzpicture}[remember picture,overlay,every node/.style={inner sep=0,outer sep=0}]
              \node[anchor=north west] at (current page.north west){\includegraphics[width=\paperwidth, page=\thepage]{\classdir /background.pdf}};
            \end{tikzpicture}
          }
        }
    }
  }

%% PDFLaTeX previous layout version
%\AddToShipoutPictureBG{
%  \AtPageLowerLeft{
%    \pdfximage{assets/background.pdf}
%    \ifthenelse{\thepage > \the\pdflastximagepages}
%      {}
%      {\includegraphics[width=\paperwidth, page=\thepage]{assets/background.pdf}}
%  }
%}


\titleformat{\section}
  {\sectiontitlecolor\LARGE\fontseries{b}\selectfont} % Format of the section title
  {\thesection} % Section number
  {1em} % Space between the number and the title
  {} % Code before the title

\titlespacing*{\section}
  {0pt}
  {4ex}
  {1.7ex}


\RequirePackage{hyperref}
\RequirePackage{url}

% https://tex.stackexchange.com/questions/157389/how-to-center-column-values-in-a-table
\RequirePackage{array} % for tables content alignement
\newcolumntype{P}[1]{>{\centering\arraybackslash}p{#1}}

\RequirePackage{lipsum}
\RequirePackage{enumitem} % for description margin adjustment

\RequirePackage{longtable}
\RequirePackage{makecell}
\RequirePackage{booktabs} % provides table rules

\RequirePackage{dirtytalk}

