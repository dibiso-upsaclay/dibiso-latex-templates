name: Create DiBISO LaTeX Template Release

on:
  push:
    tags:
      - 'v*'  # Triggers on version tags like v1.0.0, v2.1.3, etc.
  workflow_dispatch:  # Allows manual triggering
    inputs:
      tag_name:
        description: 'Release tag name (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set release variables
        id: vars
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "tag_name=${{ inputs.tag_name }}" >> $GITHUB_OUTPUT
            echo "release_name=DiBISO LaTeX Templates ${{ inputs.tag_name }}" >> $GITHUB_OUTPUT
          else
            echo "tag_name=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
            echo "release_name=DiBISO LaTeX Templates ${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi
      
      - name: Create release directory structure
        run: |
          mkdir -p release-package/dibiso-latex-template
          mkdir -p release-package/dibiso-latex-template/dibiso
      
      - name: Copy dibiso folder (cls and tex files)
        run: |
          if [ -d "dibiso" ]; then
            cp -r dibiso/* release-package/dibiso-latex-template/dibiso/
            echo "✅ Copied dibiso folder contents"
          else
            echo "⚠️ Warning: dibiso folder not found"
            exit 1
          fi
      
      - name: Copy additional files
        run: |
          # Copy README if it exists
          if [ -f "README.md" ]; then
            cp README.md release-package/dibiso-latex-template/
            echo "✅ Copied README.md"
          fi
          
          # Copy LICENSE if it exists
          if [ -f "LICENSE.txt" ]; then
            cp LICENSE.txt release-package/dibiso-latex-template/
            echo "✅ Copied LICENSE.txt"
          fi
          if [ -f "LICENSE-GPL-3.0-only.txt" ]; then
            cp LICENSE-GPL-3.0-only.txt release-package/dibiso-latex-template/
            echo "✅ Copied LICENSE-GPL-3.0-only.txt"
          fi
          if [ -f "LICENSE-lppl-1-3c.txt" ]; then
            cp LICENSE-lppl-1-3c.txt release-package/dibiso-latex-template/
            echo "✅ Copied LICENSE-lppl-1-3c.txt"
          fi
      
      - name: List package contents
        run: |
          echo "📦 Package contents:"
          find release-package/dibiso-latex-template -type f | sort
      
      - name: Create ZIP archive
        run: |
          cd release-package
          zip -r ../dibiso-latex-template-${{ steps.vars.outputs.tag_name }}.zip dibiso-latex-template/
          cd ..
          echo "✅ Created ZIP archive"
          ls -lh dibiso-latex-template-*.zip
      
      - name: Generate release notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## DiBISO LaTeX Templates Release
          
          This release contains the complete DiBISO LaTeX templates for generating reports.
          
          ### Contents
          - Complete `dibiso/` folder with class and style files
          - Usage instructions and documentation
          - License files
          
          ### Installation
          1. Download and extract the ZIP file
          2. Place the folder `dibiso` where `your-main-file.tex` is located. For  `your-main-file.tex`, you can use an example file from the repository
          3. Import the class: if `dibiso` and `your-main-file.tex` are in the same directory, use `\documentclass[french, 11pt]{dibiso/biso}`
          4. Compile with: `lualatex your-main-file.tex`
          
          ### Requirements
          - LaTeX distribution (TeX Live, MiKTeX, etc.)
          - Standard LaTeX packages
          
          ---
          **License:** LPPL 1.3c or GPL 3.0 (dual-licensed)
          EOF
      
      - name: Create GitHub Release
        uses: actions/create-release@v1
        id: create_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.vars.outputs.tag_name }}
          release_name: ${{ steps.vars.outputs.release_name }}
          body_path: release_notes.md
          draft: false
          prerelease: false
      
      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./dibiso-latex-template-${{ steps.vars.outputs.tag_name }}.zip
          asset_name: dibiso-latex-template-${{ steps.vars.outputs.tag_name }}.zip
          asset_content_type: application/zip
      
      - name: Release Summary
        run: |
          echo "✅ Release created successfully!"
          echo "📦 Package: dibiso-latex-template-${{ steps.vars.outputs.tag_name }}.zip"
          echo "🏷️ Tag: ${{ steps.vars.outputs.tag_name }}"
          echo "🔗 Release URL: ${{ steps.create_release.outputs.html_url }}"

